<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件浏览器</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome 图标 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      crossorigin="anonymous"
    >
    <style>
      .file-item, .folder-item {
        transition: all 0.2s ease;
      }
      .file-item:hover, .folder-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .breadcrumb a {
        transition: color 0.2s;
      }
      .breadcrumb a:hover {
        color: #3b82f6;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gray-50">
    <div class="container py-8 px-4 mx-auto">
      <h1 class="mb-6 text-3xl font-bold text-gray-800">文件浏览器</h1>

      <!-- 面包屑导航 -->
      <div
        id="breadcrumb"
        class="flex items-center mb-6 space-x-2 text-sm text-gray-600 breadcrumb"
      >
        <span>根目录</span>
      </div>

      <!-- 文件夹内容区域 -->
      <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
        <!-- 标题栏 -->
        <div
          class="grid grid-cols-12 gap-4 p-4 text-sm font-medium text-gray-500 border-b border-gray-200"
        >
          <div class="col-span-6">名称</div>
          <div class="col-span-3 text-right">修改日期</div>
          <div class="col-span-3 text-right">大小</div>
        </div>

        <!-- 文件夹和文件列表 -->
        <div id="file-list" class="p-4">
          <!-- 内容将通过JavaScript动态加载 -->
        </div>
      </div>

      <!-- 详细信息面板 -->
      <div
        id="detail-panel"
        class="hidden p-4 mt-6 bg-white rounded-lg border border-gray-200 shadow-sm"
      >
        <h3 class="mb-4 text-lg font-semibold text-gray-800">详细信息</h3>
        <div id="detail-content" class="space-y-2 text-sm text-gray-600">
          <!-- 详细信息内容将在这里显示 -->
        </div>
      </div>
    </div>

    <script>
      const iconMap = {
        // 代码文件 - 蓝色系
        "json": { icon: "fa-file-code", color: "text-blue-500" },
        "js": { icon: "fa-file-code", color: "text-yellow-500" },
        "jsx": { icon: "fa-file-code", color: "text-blue-400" },
        "ts": { icon: "fa-file-code", color: "text-blue-600" },
        "tsx": { icon: "fa-file-code", color: "text-blue-500" },
        "html": { icon: "fa-file-code", color: "text-orange-600" },
        "css": { icon: "fa-file-code", color: "text-blue-400" },
        "scss": { icon: "fa-file-code", color: "text-pink-500" },
        "sass": { icon: "fa-file-code", color: "text-pink-500" },
        "less": { icon: "fa-file-code", color: "text-blue-600" },
        "py": { icon: "fa-file-code", color: "text-yellow-500" },
        "java": { icon: "fa-file-code", color: "text-red-600" },
        "cpp": { icon: "fa-file-code", color: "text-blue-700" },
        "c": { icon: "fa-file-code", color: "text-blue-700" },
        "cs": { icon: "fa-file-code", color: "text-purple-600" },
        "php": { icon: "fa-file-code", color: "text-purple-500" },
        "rb": { icon: "fa-file-code", color: "text-red-600" },
        "go": { icon: "fa-file-code", color: "text-blue-500" },
        "rs": { icon: "fa-file-code", color: "text-orange-600" },
        "swift": { icon: "fa-file-code", color: "text-orange-500" },
        "kt": { icon: "fa-file-code", color: "text-purple-500" },
        "sql": { icon: "fa-file-code", color: "text-blue-600" },
        "xml": { icon: "fa-file-code", color: "text-green-600" },
        "toml": { icon: "fa-file-code", color: "text-green-600" },
        "yaml": { icon: "fa-file-code", color: "text-red-500" },
        "yml": { icon: "fa-file-code", color: "text-red-500" },
        "sh": { icon: "fa-file-code", color: "text-green-600" },
        "bat": { icon: "fa-file-code", color: "text-green-700" },
        "ps1": { icon: "fa-file-code", color: "text-blue-700" },
        "md": { icon: "fa-file-code", color: "text-blue-500" },
        "dockerfile": { icon: "fa-file-code", color: "text-blue-500" },

        // 文档文件 - 紫色/蓝色系
        "pdf": { icon: "fa-file-pdf", color: "text-red-500" },
        "doc": { icon: "fa-file-word", color: "text-blue-600" },
        "docx": { icon: "fa-file-word", color: "text-blue-600" },
        "xls": { icon: "fa-file-excel", color: "text-green-600" },
        "xlsx": { icon: "fa-file-excel", color: "text-green-600" },
        "ppt": { icon: "fa-file-powerpoint", color: "text-orange-600" },
        "pptx": {
          icon: "fa-file-powerpoint",
          color: "text-orange-600",
        },
        "txt": { icon: "fa-file-lines", color: "text-blue-600" },
        "rtf": { icon: "fa-file-lines", color: "text-blue-600" },
        "odt": { icon: "fa-file-word", color: "text-blue-500" },
        "ods": { icon: "fa-file-excel", color: "text-green-500" },
        "odp": { icon: "fa-file-powerpoint", color: "text-orange-500" },

        // 图片文件 - 绿色系
        "ico": { icon: "fa-file-image", color: "text-purple-500" },
        "jpg": { icon: "fa-file-image", color: "text-green-500" },
        "jpeg": { icon: "fa-file-image", color: "text-green-500" },
        "png": { icon: "fa-file-image", color: "text-green-500" },
        "gif": { icon: "fa-file-image", color: "text-green-500" },
        "bmp": { icon: "fa-file-image", color: "text-green-500" },
        "svg": { icon: "fa-file-image", color: "text-orange-500" },
        "webp": { icon: "fa-file-image", color: "text-green-500" },
        "tiff": { icon: "fa-file-image", color: "text-green-500" },
        "psd": { icon: "fa-file-image", color: "text-blue-500" },
        "ai": { icon: "fa-file-image", color: "text-orange-600" },
        "eps": { icon: "fa-file-image", color: "text-purple-500" },

        // 音频文件 - 粉色系
        "mp3": { icon: "fa-file-audio", color: "text-pink-500" },
        "wav": { icon: "fa-file-audio", color: "text-pink-500" },
        "flac": { icon: "fa-file-audio", color: "text-pink-600" },
        "aac": { icon: "fa-file-audio", color: "text-pink-500" },
        "ogg": { icon: "fa-file-audio", color: "text-pink-500" },
        "wma": { icon: "fa-file-audio", color: "text-pink-500" },
        "m4a": { icon: "fa-file-audio", color: "text-pink-500" },

        // 视频文件 - 红色系
        "mp4": { icon: "fa-file-video", color: "text-red-500" },
        "avi": { icon: "fa-file-video", color: "text-red-500" },
        "mov": { icon: "fa-file-video", color: "text-red-500" },
        "mkv": { icon: "fa-file-video", color: "text-red-500" },
        "flv": { icon: "fa-file-video", color: "text-red-500" },
        "wmv": { icon: "fa-file-video", color: "text-red-500" },
        "webm": { icon: "fa-file-video", color: "text-red-500" },
        "m4v": { icon: "fa-file-video", color: "text-red-500" },
        "3gp": { icon: "fa-file-video", color: "text-red-500" },

        // 压缩文件 - 橙色系
        "zip": { icon: "fa-file-zipper", color: "text-orange-500" },
        "rar": { icon: "fa-file-zipper", color: "text-orange-500" },
        "7z": { icon: "fa-file-zipper", color: "text-orange-500" },
        "tar": { icon: "fa-file-zipper", color: "text-orange-500" },
        "gz": { icon: "fa-file-zipper", color: "text-orange-500" },
        "bz2": { icon: "fa-file-zipper", color: "text-orange-500" },
        "xz": { icon: "fa-file-zipper", color: "text-orange-500" },

        // 系统文件 - 灰色系
        "exe": { icon: "fa-gear", color: "text-gray-500" },
        "dll": { icon: "fa-puzzle-piece", color: "text-gray-500" },
        "ini": { icon: "fa-gear", color: "text-gray-500" },
        "cfg": { icon: "fa-gear", color: "text-gray-500" },
        "conf": { icon: "fa-gear", color: "text-gray-500" },
        "log": { icon: "fa-file-lines", color: "text-gray-500" },

        // 字体文件
        "ttf": { icon: "fa-font", color: "text-purple-500" },
        "otf": { icon: "fa-font", color: "text-purple-500" },
        "woff": { icon: "fa-font", color: "text-purple-500" },
        "woff2": { icon: "fa-font", color: "text-purple-500" },

        // 数据文件
        "csv": { icon: "fa-file-csv", color: "text-green-600" },
        "db": { icon: "fa-database", color: "text-blue-600" },
        "sqlite": { icon: "fa-database", color: "text-blue-600" },

        // 其他常见文件类型
        "iso": { icon: "fa-compact-disc", color: "text-purple-500" },
        "apk": { icon: "fa-mobile", color: "text-green-500" },
        "dmg": { icon: "fa-compact-disc", color: "text-gray-600" },
        "deb": { icon: "fa-box", color: "text-red-500" },
        "rpm": { icon: "fa-box", color: "text-red-500" },

        // 默认文件图标
        "default": { icon: "fa-file", color: "text-gray-500" },
      };

      let folderData = {
        "target_folder": "???",
        "generated_at": "2000-01-01T00:00:00.000000+00:00",
        "files": [],
      };

      // 当前路径栈
      let pathStack = [];

      // 格式化文件大小
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " +
          sizes[i];
      }

      // 格式化日期
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("zh-CN") + " " +
          date.toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          });
      }

      // 获取文件图标
      function getFileIcon(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const icon = iconMap[ext] ?? iconMap["default"];
        return `${icon.icon} ${icon.color}`;
      }

      // 渲染面包屑导航
      function renderBreadcrumb() {
        const breadcrumb = document.getElementById("breadcrumb");
        breadcrumb.innerHTML = "";

        // 根目录链接
        const rootLink = document.createElement("a");
        rootLink.href = "#";
        rootLink.className =
          "text-blue-500 cursor-pointer hover:text-blue-700";
        rootLink.textContent = folderData.target_folder;
        rootLink.addEventListener("click", () => {
          pathStack = [];
          renderBreadcrumb();
          renderFileList(folderData.files);
        });
        breadcrumb.appendChild(rootLink);

        // 添加路径链接
        if (pathStack.length > 0) {
          let currentPath = "";
          pathStack.forEach((item, index) => {
            const separator = document.createElement("span");
            separator.textContent = " / ";
            breadcrumb.appendChild(separator);

            const pathLink = document.createElement("a");
            pathLink.href = "#";
            pathLink.className =
              "text-blue-500 cursor-pointer hover:text-blue-700";
            pathLink.textContent = item.name;

            // 保存当前路径状态
            const pathCopy = pathStack.slice(0, index + 1);
            pathLink.addEventListener("click", () => {
              navigateToPath(pathCopy);
            });

            breadcrumb.appendChild(pathLink);
          });
        }
      }

      // 导航到指定路径
      function navigateToPath(path) {
        let currentData = { files: folderData.files };

        // 遍历路径找到目标文件夹
        for (const item of path) {
          const folder = currentData.files.find((f) =>
            f.type === "folder" && f.name === item.name
          );
          if (folder) {
            currentData = folder;
          }
        }

        pathStack = path;
        renderBreadcrumb();
        renderFileList(currentData.children || currentData.files);
      }

      // 渲染文件列表
      function renderFileList(files) {
        const fileList = document.getElementById("file-list");
        fileList.innerHTML = "";

        if (!files || files.length === 0) {
          fileList.innerHTML =
            '<div class="py-8 text-center text-gray-500">此文件夹为空</div>';
          return;
        }

        // 排序：文件夹在前，文件在后，按名称排序
        const sortedFiles = [...files].sort((a, b) => {
          if (a.type !== b.type) {
            return a.type === "folder" ? -1 : 1;
          }
          return a.name.localeCompare(b.name);
        });

        sortedFiles.forEach((item) => {
          const fileElement = document.createElement("div");
          fileElement.className =
            `grid grid-cols-12 gap-4 p-3 border-b border-gray-100 ${
              item.type === "folder"
                ? "folder-item cursor-pointer hover:bg-blue-50"
                : "file-item cursor-pointer hover:bg-gray-50"
            }`;

          // 图标和名称
          const nameCell = document.createElement("div");
          nameCell.className = "flex col-span-6 items-center";

          const icon = document.createElement("i");
          icon.className = `mr-3 ${
            item.type === "folder"
              ? "fa-folder text-yellow-500"
              : getFileIcon(item.name)
          }`;
          icon.classList.add("fas");
          nameCell.appendChild(icon);

          const nameSpan = document.createElement("span");
          nameSpan.className = "truncate";
          nameSpan.textContent = item.name;
          nameCell.appendChild(nameSpan);

          // 修改日期
          const dateCell = document.createElement("div");
          dateCell.className =
            "col-span-3 text-sm text-right text-gray-500";
          dateCell.textContent = formatDate(item.last_modified_at);

          // 大小
          const sizeCell = document.createElement("div");
          sizeCell.className =
            "col-span-3 text-sm text-right text-gray-500";
          sizeCell.textContent = item.type === "folder"
            ? formatFileSize(item.total_size_bytes)
            : formatFileSize(item.size_bytes);

          fileElement.appendChild(nameCell);
          fileElement.appendChild(dateCell);
          fileElement.appendChild(sizeCell);

          // 添加点击事件
          fileElement.addEventListener("click", () => {
            if (item.type === "folder") {
              // 进入文件夹
              pathStack.push({
                name: item.name,
                relative_path: item.relative_path,
              });
              renderBreadcrumb();
              renderFileList(item.children);
            } else {
              // 显示文件详情
              showFileDetails(item);
            }
          });

          fileList.appendChild(fileElement);
        });
      }

      // 显示文件详情
      function showFileDetails(file) {
        const detailPanel = document.getElementById("detail-panel");
        const detailContent = document.getElementById("detail-content");

        detailContent.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${getFileIcon(file.name)} mr-3 text-xl"></i>
          <div>
            <div class="font-medium">${file.name}</div>
            <div class="text-xs text-gray-400">${file.relative_path}</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 pt-3">
          <div>
            <div class="text-xs text-gray-400">类型</div>
            <div>${file.name.split(".").pop().toUpperCase()} 文件</div>
          </div>
          <div>
            <div class="text-xs text-gray-400">大小</div>
            <div>${formatFileSize(file.size_bytes)}</div>
          </div>
          <div>
            <div class="text-xs text-gray-400">修改日期</div>
            <div>${formatDate(file.last_modified_at)}</div>
          </div>
          <div>
            <div class="text-xs text-gray-400">链接</div>
            <div>
              <a class="underline hover:no-underline visited:test-red-500" href="${file.relative_path}">
                <i class="fas fa-arrow-up-right-from-square"></i>
                打开
              </a>
              <span class="ml-4 underline hover:text-red-500 hover:no-underline" onclick='copyToClipboard("${location.protocol}//${location.host}/${
          encodeURI(file.relative_path)
        }")'>
                <i class="fas fa-copy"></i>
              复制
              </span>
            </div>
          </div>
        </div>
            `;

        detailPanel.classList.remove("hidden");
      }

      async function copyToClipboard(str) {
        if (typeof str !== "string" || !str) {
          return;
        }
        try {
          await navigator.clipboard.writeText(str);
        } catch (err) {
          alert(`复制失败：${err.message}`);
        }
      }
      window.copyToClipboard = copyToClipboard;

      // 初始化页面
      document.addEventListener("DOMContentLoaded", async () => {
        const res = await fetch("/site_static_files_info.nocache.json");
        folderData = await res.json();
        renderBreadcrumb();
        renderFileList(folderData.files);
      });
    </script>
  </body>
</html>
