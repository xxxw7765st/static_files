<!DOCTYPE html>
<html lang="zh-CN" x-data="fileBrowser()">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件浏览器</title>
    <!-- Tailwind CSS -->
    <script src="https://s4.zstatic.net/npm/@tailwindcss/browser@4"></script>
    <!-- Font Awesome 图标 -->
    <link
      rel="stylesheet"
      href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      crossorigin="anonymous"
    >
    <!-- Alpine.js -->
    <script
      defer
      src="https://s4.zstatic.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <style>
      .file-item, .folder-item {
        transition: all 0.2s ease;
        border-radius: 8px;
      }
      .file-item:hover, .folder-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background-color: color-mix(in srgb, dodgerblue 20%, transparent);
      }
      .file-item:hover {
        background-color: color-mix(in srgb, gray 10%, transparent);
      }
      .breadcrumb a {
        transition: color 0.2s;
      }
      .breadcrumb a:hover {
        color: #3b82f6;
      }
      .link-item {
        text-decoration: underline;
        transition: color 0.5s ease;
        user-select: none;
      }
      .link-item:hover {
        text-decoration: none;
        color: orangered;
        cursor: pointer;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gray-50">
    <div class="container py-8 px-4 mx-auto">
      <h1 class="mb-6 text-3xl font-bold text-gray-800">文件浏览器</h1>

      <!-- 面包屑导航 -->
      <div
        class="flex flex-wrap items-center mb-6 space-x-2 text-sm text-gray-600 breadcrumb"
      >
        <template x-for="(item, index) in breadcrumbItems" :key="index">
          <div class="flex items-center">
            <span
              x-show="index > 0"
              class="mx-2"
            >/</span>
            <span
              x-text="item.name"
              :class="index === breadcrumbItems.length - 1 ? 'text-gray-800 font-medium' : 'text-blue-500 cursor-pointer hover:text-blue-700'"
              @click="navigateToBreadcrumb(index)"
            ></span>
          </div>
        </template>
      </div>

      <!-- 文件夹内容区域 -->
      <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
        <!-- 标题栏 -->
        <div
          class="grid grid-cols-12 gap-4 p-4 px-6 text-sm font-medium text-gray-500 border-b border-gray-200"
        >
          <div class="col-span-6">名称</div>
          <div class="col-span-3 text-right">修改日期</div>
          <div class="col-span-3 text-right">大小</div>
        </div>

        <!-- 文件夹和文件列表 -->
        <div class="py-4 px-4">
          <template x-if="currentFiles.length === 0">
            <div class="py-8 text-center text-gray-500">此文件夹为空</div>
          </template>

          <template x-for="item in sortedFiles" :key="item.id">
            <div
              class="grid grid-cols-12 gap-4 p-2 border-b border-gray-100 cursor-pointer"
              :class="item.type === 'folder' ? 'folder-item' : 'file-item'"
              @click="item.type === 'folder' ? enterFolder(item) : showDetails(item)"
              :data-item-id="item.id"
            >
              <!-- 图标和名称 -->
              <div class="flex col-span-6 items-center">
                <i
                  class="mr-3 fas"
                  :class="item.type === 'folder' ? 'fa-folder text-yellow-500' : getFileIcon(item.name)"
                ></i>
                <span class="truncate" x-text="getFileName(item)"></span>
              </div>

              <!-- 修改日期 -->
              <div
                class="col-span-3 text-xs justify-end text-gray-500 of-scroll flex items-center"
                style="white-space: nowrap; overflow: auto"
                x-text="formatShortDate(item.updated_at || item.last_modified_at)"
              >
              </div>

              <!-- 大小 -->
              <div class="col-span-3 text-xs justify-end text-gray-500 flex items-center">
                <span
                  x-text="formatFileSize(item.type === 'folder' ? (item.size || item.total_size_bytes || 0) : (item.size || item.size_bytes || 0))"
                ></span>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- 详细信息面板 -->
      <div
        class="p-4 mt-6 bg-white rounded-lg border border-gray-200 shadow-sm"
        x-show="detailItem"
        x-transition
      >
        <h3 class="mb-4 text-lg font-semibold text-gray-800">详细信息</h3>
        <div class="space-y-2 text-sm text-gray-600">
          <template x-if="detailItem">
            <div>
              <div class="flex items-center">
                <i
                  class="mr-3 text-xl fas"
                  :class="detailItem.type === 'folder' ? 'fa-folder text-yellow-500' : getFileIcon(detailItem.name)"
                ></i>
                <div>
                  <div class="font-medium" x-text="detailItem.name"></div>
                  <div
                    class="text-xs text-gray-400"
                    x-text="getFileWebPath(detailItem)"
                  >
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4 pt-3">
                <div>
                  <div class="text-xs text-gray-400">类型</div>
                  <div
                    x-text="detailItem.type === 'folder' ? '文件夹' : detailItem.name.split('.').pop().toUpperCase() + ' 文件'"
                  >
                  </div>
                </div>
                <div>
                  <div class="text-xs text-gray-400">大小</div>
                  <div
                    x-text="formatFileSize(detailItem.type === 'folder' ? (detailItem.size || detailItem.total_size_bytes || 0) : (detailItem.size || detailItem.size_bytes || 0))"
                  >
                  </div>
                </div>
                <div>
                  <div class="text-xs text-gray-400">修改日期</div>
                  <div
                    x-text="formatDate(detailItem.updated_at || detailItem.last_modified_at)"
                  >
                  </div>
                </div>
                <template x-if="detailItem.type === 'file'">
                  <div>
                    <div class="text-xs text-gray-400">链接</div>
                    <div class="flex gap-4 of-auto">
                      <a
                        class="link-item"
                        :href="getFileUrl(detailItem)"
                        target="_blank"
                      >
                        <i class="fas fa-arrow-up-right-from-square"></i>
                        打开
                      </a>
                      <span
                        class="link-item"
                        @click="copyToClipboard(getFileUrl(detailItem))"
                      >
                        <i class="fas fa-copy"></i>
                        复制
                      </span>
                    </div>
                  </div>
                </template>
                <template x-if="detailItem.type === 'folder'">
                  <div>
                    <div class="text-xs text-gray-400">统计</div>
                    <div>
                      <span x-text="getFolderCount(detailItem)"></span> 文件夹，
                      <span x-text="getFileCount(detailItem)"></span> 文件
                    </div>
                  </div>
                </template>
                <div class="col-span-2">
                  <div class="text-xs text-gray-400">操作</div>
                  <div class="flex gap-4 of-auto">
                    <a
                      class="link-item"
                      href="manager.html"
                      target="_blank"
                    >
                      <i class="fas fa-brands fa-github"></i>
                      管理
                    </a>
                    <template x-if="detailItem.type === 'file'">
                      <a
                        class="link-item"
                        :href="'manager.html#'+getFileRepoPath(detailItem)"
                        target="_blank"
                      >
                        <i class="fas fa-regular fa-pen-to-square"></i>
                        编辑
                      </a>
                    </template>
                    <template x-if="detailItem.type === 'folder'">
                      <a
                        class="link-item"
                        :href="'manager.html#'+getFileRepoPath(detailItem)"
                        target="_blank"
                      >
                        <i class="fas fa-circle-plus"></i>
                        新建文件
                      </a>
                    </template>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>

    <script>
      function fileBrowser() {
        return {
          // 图标映射
          iconMap: {
            "txt": { icon: "fa-file-lines", color: "text-blue-600" },
            "jpg": { icon: "fa-file-image", color: "text-green-500" },
            "png": { icon: "fa-file-image", color: "text-green-500" },
            "default": { icon: "fa-file", color: "text-gray-500" },
          },

          // 文件集合配置
          fileCollections: [],

          // 合并后的文件夹数据
          folderData: {
            target_folder: "根目录",
            generated_at: new Date().toISOString(),
            files: [],
          },

          // 当前路径栈
          pathStack: [],
          currentFiles: [],
          detailItem: null,

          async init() {
            try {
              // 1. 加载图标映射
              try {
                const iconMapResponse = await fetch(
                  "./files_info_collections.jsonc",
                );
                if (iconMapResponse.ok) {
                  const iconMapData = await iconMapResponse.json();
                  this.iconMap = {
                    ...this.iconMap,
                    ...iconMapData,
                  };
                }
              } catch (e) {
                console.warn("无法加载图标映射文件，使用默认图标");
              }

              // 2. 加载文件集合索引
              const collectionsResponse = await fetch(
                "./files_info_collections.jsonc",
              );
              this.fileCollections = await collectionsResponse.json();

              // 3. 加载所有文件集合
              const collectionPromises = this.fileCollections.map(
                async (collection) => {
                  try {
                    const response = await fetch(collection.url);
                    if (!response.ok) {
                      throw new Error(`无法加载 ${collection.name}`);
                    }

                    const data = await response.json();
                    const { web_prefix, path_prefix } = collection;

                    // 将对象结构的children转换为数组结构
                    if (
                      data.children && typeof data.children === "object"
                    ) {
                      data.children = this.childrenObjectToArray(
                        data.children,
                        {
                          web_prefix,
                          path_prefix,
                        },
                      );
                    }

                    // 添加集合信息
                    data.collection = collection;

                    return data;
                  } catch (error) {
                    console.error(
                      `加载集合 ${collection.name} 失败:`,
                      error,
                    );
                    return null;
                  }
                },
              );

              const collectionsData = await Promise.all(
                collectionPromises,
              );

              // 4. 合并所有集合数据
              this.folderData.files = collectionsData.filter((item) =>
                item !== null
              );

              // 5. 设置当前文件列表
              this.currentFiles = this.folderData.files;

              // 6. 为每个项目添加唯一ID
              this.assignIds(this.currentFiles);
            } catch (error) {
              console.error("初始化失败:", error);
              document.getElementById("file-list").innerHTML =
                '<div class="py-8 text-center text-red-500">加载文件列表失败，请刷新页面重试</div>';
            }
          },

          get breadcrumbItems() {
            const items = [{ name: this.folderData.target_folder }];

            this.pathStack.forEach((item) => {
              items.push({ name: item.name });
            });

            return items;
          },

          get sortedFiles() {
            return [...this.currentFiles].sort((a, b) => {
              if (a.type !== b.type) {
                return a.type === "folder" ? -1 : 1;
              }
              return a.name.localeCompare(b.name);
            });
          },

          formatFileSize(bytes) {
            if (bytes === 0) return "0 B";
            const k = 1024;
            const sizes = ["B", "KB", "MB", "GB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
              " " + sizes[i];
          },

          formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString("zh-CN") + " " +
              date.toLocaleTimeString("zh-CN", {
                hour: "2-digit",
                minute: "2-digit",
              });
          },
          _today_date: new Date(),
          formatShortDate(dateString) {
            const d = new Date(dateString);
            if (isNaN(d.getTime())) return "";
            const t = d.getTime();
            const todayStart = new Date().setHours(0, 0, 0, 0);
            const dayMs = 86400000;
            return t >= todayStart && t < todayStart + dayMs
              ? `${d.getHours()}:${d.getMinutes()}`
              : t >= todayStart - dayMs && t < todayStart
              ? `昨天 ${d.getHours()}:${d.getMinutes()}`
              : `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
          },

          getFileIcon(filename) {
            const ext = filename.split(".").pop().toLowerCase();
            const icon = this.iconMap[ext] || this.iconMap["default"];
            return `${icon.icon} ${icon.color}`;
          },

          childrenObjectToArray(childrenObj, injects = {}) {
            if (!childrenObj) return [];
            return Object.values(childrenObj).map((item) => {
              if (item.type === "folder" && item.children) {
                item.children = this.childrenObjectToArray(
                  item.children,
                  injects,
                );
              }
              item = {
                ...injects,
                ...item,
              };
              return item;
            });
          },

          assignIds(items, parentId = "") {
            items.forEach((item, index) => {
              item.id = parentId
                ? `${parentId}-${index}`
                : `item-${index}`;
              if (item.children) {
                this.assignIds(item.children, item.id);
              }
            });
          },

          enterFolder(folder) {
            this.pathStack.push({
              name: folder.name,
              relative_path: folder.relative_path,
            });
            this.currentFiles = folder.children || [];
            this.showDetails(folder);
          },

          navigateToBreadcrumb(index) {
            if (index === 0) {
              this.pathStack = [];
              this.currentFiles = this.folderData.files;
              this.detailItem = null;
            } else {
              this.pathStack = this.pathStack.slice(0, index);

              const folder = this.getFolderAtPath(this.pathStack);
              this.currentFiles = folder?.children || [];
              this.detailItem = folder;
            }
          },

          getFolderAtPath(path) {
            let currentFolder = this.folderData;

            for (const pathItem of path) {
              const children = currentFolder.files ||
                currentFolder.children || [];
              const folder = children.find((f) =>
                f.type === "folder" && f.name === pathItem.name
              );
              if (folder) {
                currentFolder = folder;
              } else {
                break;
              }
            }
            return currentFolder;
          },

          showDetails(item) {
            this.detailItem = item;
          },

          getFileName(file) {
            const name = file.name || "???";
            return name.replace(/_H[0-9a-zA-Z]{8}_/g, "");
          },
          getFileWebPath(file) {
            return `${file.web_prefix || ""}${file.relative_path}`;
          },
          getFileRepoPath(file) {
            const path = `${
              file.path_prefix || ""
            }${file.relative_path}`;
            if (
              file.type === "folder" && path[path.length - 1] !== "/"
            ) {
              return path + "/";
            }
            return path;
          },
          getFileUrl(file) {
            const web_path = this.getFileWebPath(file);
            const { host, protocol, hostname, pathname } = location;
            if (
              hostname === "127.0.0.1" || hostname === "localhost" ||
              hostname?.startsWith?.("192.168.")
            ) {
              return `${protocol}//${host}/${
                this.getFileRepoPath(file)
              }`;
            }
            return `${protocol}//${host}${web_path}`;
          },

          async copyToClipboard(str) {
            if (typeof str !== "string" || !str) return;

            try {
              await navigator.clipboard.writeText(str);
              alert("链接已复制到剪贴板");
            } catch (err) {
              alert(`复制失败：${err.message}`);
            }
          },

          getFileCount(folder) {
            if (!folder.children) return 0;
            return folder.children.filter((item) =>
              item.type === "file"
            ).length;
          },

          getFolderCount(folder) {
            if (!folder.children) return 0;
            return folder.children.filter((item) =>
              item.type === "folder"
            ).length;
          },
        };
      }
    </script>
  </body>
</html>
