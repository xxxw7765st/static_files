<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub文件管理器</title>
    <script src="https://s4.zstatic.net/npm/@tailwindcss/browser@4"></script>
    <style>
      button {
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
      }

      .open-collapse-indicator {
        rotate: 180deg;
        transition: rotate 0.3s ease;
      }

      .file-item {
        border-bottom: 1px solid #e5e7eb;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
        transition: all 0.2s ease;
      }

      .of-text-ellipsis {
        display: -webkit-box;
        display: box;
        white-space: normal;
        overflow: hidden;
        -webkit-text-overflow: ellipsis;
        text-overflow: ellipsis;
        -webkit-box-orient: vertical;
        box-orient: vertical;
        --max-line: 1;
        -webkit-line-clamp: var(--line-count);
        line-clamp: var(--line-count);
      }

      /* 输入框清空按钮样式 */
      .input-clear-btn {
        position: absolute;
        right: 0.5rem;
        bottom: 0;
        transform: translateY(-50%);
        width: 1.25rem;
        height: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 50%;
        cursor: pointer;
        transition: opacity 0.15s ease-in-out;
      }
      .input-clear-btn:hover {
        opacity: 80%;
      }
      .input-clear-btn::before {
        content: "×";
        font-size: 1.2rem;
        font-weight: bold;
      }
      .input-with-clear {
        position: relative;
      }
      .input-with-clear input {
        outline-color: royalblue;
        padding-right: 2rem; /* 为清空按钮留出空间 */
      }
      .hover-light:hover {
        opacity: 60%;
      }
      .hover-shadow:hover {
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: box-shadow 0.3s ease;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50">
    <div
      x-data="githubFileManager()"
      class="container py-8 px-4 mx-auto max-w-4xl"
    >
      <header class="mb-8 text-center">
        <h1
          class="mb-2 text-4xl font-bold"
          style="background: linear-gradient(90deg, #58a6ff, #f778ba); -webkit-background-clip: text; -webkit-text-fill-color: transparent"
        >
          GitHub文件管理器
        </h1>
      </header>

      <!-- 配置面板 -->
      <div class="mb-6 bg-white rounded-xl border border-gray-200 shadow-lg">
        <div class="p-4 border-b border-gray-100">
          <h2
            class="flex justify-between items-center text-lg font-semibold transition-colors cursor-pointer"
            @click="toggleConfigPanel"
          >
            <span class="flex items-center">
              <svg
                class="mr-2 w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                >
                </path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                >
                </path>
              </svg>
              配置
              <span
                x-text="`(${config.owner}/${config.repo})`"
                class="ml-2 text-sm text-gray-500"
              ></span>
            </span>
            <svg
              :class="configPanelOpen ? '' : 'open-collapse-indicator'"
              class="w-5 h-5 text-gray-500 shrink-0"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              fill="none"
              viewBox="0 0 24 24"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m5 15 7-7 7 7"
              />
            </svg>
          </h2>
          <div x-show="configPanelOpen" x-collapse class="mt-4">
            <div class="grid gap-4 md:grid-cols-3">
              <div class="input-with-clear">
                <label class="block mb-1 text-sm font-medium text-gray-700"
                >PAT</label>
                <input
                  type="password"
                  x-model="config.pat"
                  class="py-2 px-3 w-full rounded-lg border border-gray-300 transition"
                >
                <div
                  x-show="config.pat"
                  @click="config.pat = ''"
                  class="input-clear-btn"
                >
                </div>
              </div>
              <div class="input-with-clear">
                <label class="block mb-1 text-sm font-medium text-gray-700"
                >Owner</label>
                <input
                  type="text"
                  x-model="config.owner"
                  class="py-2 px-3 w-full rounded-lg border border-gray-300 transition"
                >
                <div
                  x-show="config.owner"
                  @click="config.owner = ''"
                  class="input-clear-btn"
                >
                </div>
              </div>
              <div class="input-with-clear">
                <label class="block mb-1 text-sm font-medium text-gray-700"
                >Repo</label>
                <input
                  type="text"
                  x-model="config.repo"
                  class="py-2 px-3 w-full rounded-lg border border-gray-300 transition"
                >
                <div
                  x-show="config.repo"
                  @click="config.repo = ''"
                  class="input-clear-btn"
                >
                </div>
              </div>
              <div class="input-with-clear">
                <label class="block mb-1 text-sm font-medium text-gray-700"
                >Branch</label>
                <input
                  type="text"
                  x-model="config.branch"
                  class="py-2 px-3 w-full rounded-lg border border-gray-300 transition"
                >
                <div
                  x-show="config.branch"
                  @click="config.branch = ''"
                  class="input-clear-btn"
                >
                </div>
              </div>
              <div class="input-with-clear">
                <label class="block mb-1 text-sm font-medium text-gray-700"
                >path prefix</label>
                <input
                  type="text"
                  x-model="config.prefix"
                  class="py-2 px-3 w-full rounded-lg border border-gray-300 transition"
                >
                <div
                  x-show="config.prefix"
                  @click="config.prefix = ''"
                  class="input-clear-btn"
                >
                </div>
              </div>
              <div class="opacity-80" x-show="prefix_suggestions?.length > 0">
                <div class="mb-1 text-sm font-medium text-gray-700">
                  prefix 提示
                </div>
                <div class="flex overflow-auto gap-2 py-2 px-3">
                  <template x-for="item in prefix_suggestions">
                    <button
                      class="py-1 px-3 text-blue-700 bg-blue-50 rounded-lg border-2 border-blue-200 transition hover-light"
                      x-text="item.name"
                      @click="config.prefix = item.path_prefix"
                    >
                    </button>
                  </template>
                </div>
              </div>
            </div>
            <div class="flex gap-2 mt-4">
              <button
                @click="saveConfig"
                class="py-2 px-4 text-white bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-sm hover-light"
              >
                保存
              </button>
              <button
                @click="loadConfig"
                class="py-2 px-4 text-white bg-gradient-to-r from-gray-500 to-gray-600 rounded-lg shadow-sm hover-light"
              >
                加载
              </button>
              <button
                @click="clearConfig"
                class="py-2 px-4 text-white bg-gradient-to-r from-red-500 to-red-600 rounded-lg shadow-sm hover-light"
              >
                清除
              </button>
              <button
                @click="openGithub"
                class="py-2 px-4 text-white bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-sm hover-light"
              >
                Github
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 行为面板 -->
      <div class="bg-white rounded-xl border border-gray-200 shadow-lg">
        <!-- Tab导航 -->
        <div class="p-4 border-b border-gray-100">
          <nav class="flex overflow-x-auto justify-between md:justify-around">
            <template x-for="tab in tabs">
              <button
                @click="activeTab = tab.id"
                :class="activeTab === tab.id ? 
                  'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow' : 
                  'text-gray-500 hover-light'"
                class="py-2 px-4 text-sm font-medium whitespace-nowrap rounded-lg transition-all"
                x-text="tab.name"
              >
              </button>
            </template>
          </nav>
        </div>

        <!-- Tab内容 -->
        <div class="p-4">
          <!-- 上传面板 -->
          <div x-show="activeTab === 'upload'">
            <div class="mb-4">
              <div class="flex items-center mb-4">
                <input
                  type="file"
                  @change="addFiles"
                  multiple
                  class="hidden"
                  id="fileInput"
                >
                <button
                  @click="document.getElementById('fileInput').click()"
                  class="flex items-center py-2 px-4 text-white bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-sm hover-light"
                >
                  <svg
                    class="mr-2 w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                    >
                    </path>
                  </svg>
                  选择文件
                </button>

                <span
                  class="flex items-center py-1 px-3 ml-auto text-sm text-gray-500 bg-gray-100 rounded-lg"
                >
                  文件数量:
                  <span
                    class="pl-2 font-medium"
                    x-text="uploadFiles.length"
                  ></span>
                </span>
              </div>

              <!-- 文件列表 -->
              <div x-show="uploadFiles.length > 0" class="space-y-3">
                <template x-for="(file, index) in uploadFiles" :key="file.id">
                  <div
                    class="p-4 bg-gray-50 rounded-lg transition hover-shadow"
                    :class="{'border-l-4': file.status, 
                                                                                      'border-green-500': file.status === 'success',
                                                                                      'border-red-500': file.status === 'error'}"
                  >
                    <!-- 第一行：文件名和状态 -->
                    <div class="flex justify-between items-center mb-2">
                      <div class="flex-1 mr-2 input-with-clear">
                        <input
                          type="text"
                          x-model="file.name"
                          :placeholder="file.origin_file.name"
                          :disabled="file.status === 'success'"
                          class="py-2 px-3 w-full text-sm rounded-lg border border-gray-300 transition"
                        >
                        <div
                          x-show="file.name && file.status !== 'success'"
                          @click="file.name = ''"
                          class="input-clear-btn"
                        >
                        </div>
                      </div>
                      <div
                        x-show="file.status"
                        class="py-1 px-2 text-xs font-medium rounded"
                        :class="file.status === 'success' ? 'bg-green-100 text-green-800' : 
                                                     file.status === 'error' ? 'bg-red-100 text-red-800' : ''"
                      >
                        <span
                          x-text="file.status === 'success' ? '成功' : 
                                                         file.status === 'error' ? '失败' : ''"
                        ></span>
                      </div>
                    </div>

                    <!-- 第二行：大小信息和操作按钮 -->
                    <div class="flex justify-between items-center">
                      <div class="text-sm text-gray-500">
                        <span x-text="formatFileSize(file.file.size)"></span>
                        <span
                          x-show="file.error"
                          class="ml-2 text-red-500"
                          x-text="'错误: ' + file.error"
                        ></span>
                      </div>
                      <div class="flex gap-2">
                        <!-- 重置更改 -->
                        <button
                          @click="resetFile(index)"
                          class="py-1 px-3 text-sm text-gray-600 bg-gray-100 rounded transition hover-shadow"
                          x-show="file.name !== file.origin_file.name || file.file !== file.origin_file"
                        >
                          重置
                        </button>

                        <!-- 文件操作按钮 -->
                        <button
                          @click="showFileOperations(index)"
                          class="py-1 px-3 text-sm text-blue-600 bg-blue-100 rounded transition hover-shadow"
                        >
                          操作
                        </button>

                        <!-- 删除文件 -->
                        <button
                          @click="removeFile(index)"
                          class="py-1 px-3 text-sm text-red-600 bg-red-100 rounded transition hover-shadow"
                        >
                          删除
                        </button>
                      </div>
                    </div>
                  </div>
                </template>

                <button
                  @click="uploadAllFiles"
                  :disabled="!isConfigValid || uploadFiles.length === 0"
                  :class="{'bg-gradient-to-r from-green-500 to-green-600 hover-light shadow-sm': isConfigValid && uploadFiles.length > 0, 
                                            'bg-gray-300 cursor-not-allowed': !isConfigValid || uploadFiles.length === 0}"
                  class="py-3 px-4 w-full font-medium text-white rounded-lg transition-all"
                >
                  确认上传
                </button>
              </div>

              <div
                x-show="uploadFiles.length === 0"
                class="py-12 text-center text-gray-500 rounded-lg border-2 border-gray-300 border-dashed"
              >
                <svg
                  class="mx-auto w-12 h-12 text-gray-400"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"
                  >
                  </path>
                </svg>
                <p class="mt-2">暂无文件，请点击上方按钮选择文件</p>
              </div>
            </div>
          </div>

          <!-- 删除面板 -->
          <div x-show="activeTab === 'delete'" class="space-y-4">
            <div class="input-with-clear">
              <label class="block text-sm font-medium text-gray-700"
              >文件路径</label>
              <input
                type="text"
                x-model="deletePath"
                placeholder="folder/file.txt"
                class="py-2 px-3 mt-1 w-full rounded-lg border border-gray-300 transition"
              >
              <div
                x-show="deletePath"
                @click="deletePath = ''"
                class="input-clear-btn"
              >
              </div>
            </div>
            <button
              @click="deleteFile"
              :disabled="!deletePath || !isConfigValid"
              :class="{'bg-gradient-to-r from-red-500 to-red-600 hover-light shadow-sm': deletePath && isConfigValid, 
                                    'bg-gray-300 cursor-not-allowed': !deletePath || !isConfigValid}"
              class="py-2 px-4 font-medium text-white rounded-lg transition-all"
            >
              确认删除
            </button>
          </div>

          <!-- 重命名面板 -->
          <div x-show="activeTab === 'rename'" class="space-y-4">
            <div
              class="flex items-start p-4 mb-4 text-sm bg-orange-50 rounded-lg border border-orange-200"
              role="alert"
            >
              <svg
                class="mt-0.5 w-4 h-4 text-orange-500 sm:mt-0 me-2 shrink-0"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="none"
                viewBox="0 0 24 24"
              >
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 11h2v5m-2 0h4m-2.592-8.5h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                />
              </svg>
              <p class="text-orange-700">
                <span class="font-medium me-1"> 注意 </span>
                重命名会下载原始文件, 重命名后重新上传, 请避免不必要的流量消耗!
              </p>
            </div>
            <div class="grid gap-4 md:grid-cols-2">
              <div class="input-with-clear">
                <label class="block text-sm font-medium text-gray-700"
                >原文件路径</label>
                <input
                  type="text"
                  x-model="renameOldPath"
                  placeholder="folder/old-file.txt"
                  class="py-2 px-3 mt-1 w-full rounded-lg border border-gray-300 transition"
                >
                <div
                  x-show="renameOldPath"
                  @click="renameOldPath = ''"
                  class="input-clear-btn"
                >
                </div>
              </div>
              <div class="input-with-clear">
                <label class="block text-sm font-medium text-gray-700"
                >新文件路径</label>
                <input
                  type="text"
                  x-model="renameNewPath"
                  placeholder="folder/new-file.txt"
                  class="py-2 px-3 mt-1 w-full rounded-lg border border-gray-300 transition"
                >
                <div
                  x-show="renameNewPath"
                  @click="renameNewPath = ''"
                  class="input-clear-btn"
                >
                </div>
              </div>
            </div>
            <button
              @click="renameFile"
              :disabled="!renameOldPath || !renameNewPath || !isConfigValid"
              :class="{'bg-gradient-to-r from-blue-500 to-blue-600 hover-light shadow-sm': renameOldPath && renameNewPath && isConfigValid, 
                                    'bg-gray-300 cursor-not-allowed': !renameOldPath || !renameNewPath || !isConfigValid}"
              class="py-2 px-4 font-medium text-white rounded-lg transition-all"
            >
              确认重命名
            </button>
          </div>

          <!-- 历史记录面板 -->
          <div x-show="activeTab === 'history'" class="space-y-4">
            <div class="flex justify-between items-center">
              <h3 class="flex items-center text-lg font-medium">
                <svg
                  class="mr-2 w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  >
                  </path>
                </svg>
                操作历史
              </h3>
              <button
                @click="clearHistory"
                class="flex items-center py-1 px-3 text-sm text-white bg-gradient-to-r from-red-500 to-red-600 rounded shadow-sm transition hover-light"
                x-show="history.length > 0"
              >
                <svg
                  class="mr-1 w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                  >
                  </path>
                </svg>
                清除历史
              </button>
            </div>

            <div
              x-show="history.length === 0"
              class="py-12 text-center text-gray-500 rounded-lg border-2 border-gray-300 border-dashed"
            >
              <svg
                class="mx-auto w-12 h-12 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                >
                </path>
              </svg>
              <p class="mt-2">暂无操作历史</p>
            </div>

            <div x-show="history.length > 0" class="space-y-3">
              <template
                x-for="(record, index) in history"
                :key="record.timestamp"
              >
                <div
                  class="overflow-hidden rounded-lg border border-gray-200 transition hover-shadow"
                >
                  <!-- 历史记录头部 -->
                  <div
                    class="p-3 bg-gray-50 transition cursor-pointer"
                    @click="toggleHistoryDetail(index)"
                  >
                    <div
                      class="flex gap-2 justify-between items-center text-sm"
                    >
                      <div class="flex flex-col flex-grow">
                        <div
                          class="mb-2 text-sm break-all of-text-ellipsis"
                          style="--max-line: 2"
                          x-text="getHistoryTitle(record)"
                        >
                        </div>
                        <div class="flex gap-3 items-center text-xs">
                          <div
                            class="py-1 px-2 text-xs font-medium rounded"
                            :class="getHistoryBadgeClass(record.action)"
                          >
                            <span
                              x-text="getActionText(record.action)"
                            ></span>
                            <span
                              x-text="record.data.success ? ' ✓' : ' ×'"
                            >
                            </span>
                          </div>
                          <div
                            class="of-auto"
                            x-text="formatTime(record.timestamp)"
                          >
                          </div>
                          <div
                            x-text="record.data.size > -1 ? formatFileSize(record.data.size) : ''"
                          >
                          </div>
                        </div>
                      </div>
                      <div
                        class="flex flex-shrink-0 gap-2 items-center text-sm text-gray-500"
                      >
                        <div
                          :class="historyOpenIndex === index ? '' : 'open-collapse-indicator'"
                        >
                          <svg
                            class="w-5 h-5 shrink-0"
                            aria-hidden="true"
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            fill="none"
                            viewBox="0 0 24 24"
                          >
                            <path
                              stroke="currentColor"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="m5 15 7-7 7 7"
                            />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- 历史记录详情 -->
                  <div
                    x-show="historyOpenIndex === index"
                    x-collapse
                    class="p-3 border-t border-gray-100"
                  >
                    <pre
                      x-text="JSON.stringify(record, null, 2)"
                      class="overflow-auto p-3 max-h-60 text-xs whitespace-pre-wrap bg-gray-50 rounded-lg"
                    ></pre>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 模块脚本，暴露到window -->
    <script type="module" src="github-api.js"></script>
    <script type="module" src="components.js"></script>

    <!-- 非模块脚本，使用window上的对象 -->
    <script src="manager.js"></script>
    <script
      defer
      src="https://s4.zstatic.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"
    ></script>
    <script
      defer
      src="https://s4.zstatic.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </body>
</html>
